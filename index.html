<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save Location to Firebase</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtQfu6HHTg43UgDXy0Qy2itaC67wB40gM" async></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        #info {
            height: 10%;  /* 브라우저 높이의 10% */
            background-color: #f9f9f9;
            padding: 10px;
            font-family: Arial, sans-serif;
            overflow: auto;
        }
        #map {
            height: 90%;  /* 브라우저 높이의 나머지 90% */
            width: 100%;
        }
        #login-form {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .user-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 50%;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBtQfu6HHTg43UgDXy0Qy2itaC67wB40gM",
            authDomain: "localsharing-9fc8a.firebaseapp.com",
            databaseURL: "https://localsharing-9fc8a-default-rtdb.firebaseio.com",
            projectId: "localsharing-9fc8a",
            storageBucket: "localsharing-9fc8a.appspot.com",
            messagingSenderId: "380488977065",
            appId: "1:380488977065:web:0390e482627e961567b7b8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const database = getDatabase(app);

        const colors = ['#FF0000', '#0000FF', '#00FF00', '#FFFF00', '#FF00FF', '#00FFFF'];  // 고정된 핀 색깔 배열

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-form').style.display = 'none';
                initMap(user);
            } else {
                document.getElementById('login-form').style.display = 'block';
            }
        });

        function login(email, password) {
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    console.log("User logged in:", userCredential.user);
                })
                .catch((error) => {
                    console.error("Login error:", error);
                    alert("Login failed: " + error.message);
                });
        }

        function saveLocationToFirebase(user, location) {
            const updates = {
                latitude: location.lat,
                longitude: location.lng,
                timestamp: Date.now() // 현재 시간을 타임스탬프로 저장 (UTC)
            };

            update(ref(database, 'users/' + user.uid), updates);
        }

        function formatKSTTime(utcTimestamp) {
            const date = new Date(utcTimestamp); // UTC 타임스탬프를 Date 객체로 변환            
            const kstDate = new Date(date.getTime()); // KST로 변환

            const month = String(kstDate.getMonth() + 1).padStart(2, '0');
            const day = String(kstDate.getDate()).padStart(2, '0');
            const hours = String(kstDate.getHours()).padStart(2, '0');
            const minutes = String(kstDate.getMinutes()).padStart(2, '0');
            const seconds = String(kstDate.getSeconds()).padStart(2, '0');

            return `${month}/${day} ${hours}:${minutes}:${seconds}`;
        }

        function displayUsersInfo(map, currentUserId) {
            const usersRef = ref(database, 'users/');
            const infoDiv = document.getElementById('info');

            onValue(usersRef, (snapshot) => {
                const users = snapshot.val();
                const userIds = Object.keys(users);
                infoDiv.innerHTML = '';  // 기존 내용 초기화

                userIds.forEach((userId, index) => {
                    const userLocation = users[userId];
                    const userColor = colors[index % colors.length];  // 고정된 색상 선택

                    // UTC 타임스탬프를 KST로 변환
                    const formattedTime = formatKSTTime(userLocation.timestamp);

                    // 사용자 정보를 상단에 표시
                    const userInfo = document.createElement('div');
                    userInfo.innerHTML = `<span class="user-color" style="background-color: ${userColor};"></span>${userLocation.name} - Last updated: ${formattedTime}`;
                    infoDiv.appendChild(userInfo);

                    // 사용자 위치에 핀 추가
                    new google.maps.Marker({
                        position: { lat: userLocation.latitude, lng: userLocation.longitude },
                        map: map,
                        title: `${userLocation.name} - Last updated: ${formattedTime}`,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: userColor,
                            fillOpacity: 1,
                            strokeWeight: 2,
                            strokeColor: '#000000'
                        }
                    });
                });
            });
        }

        function initMap(user) {
            const mapOptions = {
                zoom: 15,
            };
            const map = new google.maps.Map(document.getElementById('map'), mapOptions);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    map.setCenter(userLocation);  // 초기 위치에서만 중심 설정

                    const userName = user.email.split('@')[0]; // 예시로 이메일의 앞부분을 이름으로 사용
                    new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: userName,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#FF0000',  // 자신의 핀은 빨간색
                            fillOpacity: 1,
                            strokeWeight: 2,
                            strokeColor: '#000000'
                        }
                    });

                    // 최초 위치 저장
                    saveLocationToFirebase(user, userLocation);

                    // 1초마다 위치를 업데이트
                    setInterval(() => {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            const updatedLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };

                            // 사용자 위치만 업데이트 (지도 중심 변경 없음)
                            saveLocationToFirebase(user, updatedLocation);
                        });
                    }, 1000);

                    displayUsersInfo(map, user.uid);

                }, function() {
                    console.error("Geolocation service failed");
                });
            } else {
                console.error("Your browser doesn't support geolocation.");
            }
        }

        window.onload = () => {
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                login(email, password);
            });
        };
    </script>
</head>
<body>
    <div id="info"></div>
    <div id="map"></div>
    <div id="login-form" style="display:none;">
        <h2>Login</h2>
        <form id="login-form2">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
            <br>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
            <br>
            <button type="submit">Login</button>
        </form>
    </div>
</body>
</html>
